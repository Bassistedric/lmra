<!doctype html>
<html lang="fr">
<head>
  <!-- ===== MÉTA & PWA ===== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>VMA – Apps chantier</title>

  <!-- Manifest + icônes PWA (remplace icon-192/512.png par tes fichiers QHSE) -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Tailwind (CDN pour simplicité) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Impression propre du formulaire */
    @media print{
      header,footer,.no-print{display:none!important}
      main{max-width:100%!important}
      section{page-break-inside:avoid}
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="root"></div>

  <!-- ===== ENREGISTREMENT SERVICE WORKER (PWA) =====
       -> Bumper la query (?v=...) à chaque mise à jour pour casser le cache -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () =>
        navigator.serviceWorker.register('./sw.js?v=v3-2k6').catch(console.error)
      );
    }
  </script>

  <!-- ===== REACT + BABEL (CDN) ===== -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- ===== CHARGEUR LIB QR AVEC FALLBACK (jsDelivr -> unpkg) =====
       On le charge AVANT notre code React pour pouvoir dessiner le QR côté client. -->
  <script>
  (function () {
    function add(src){ var s=document.createElement('script'); s.src=src; s.crossOrigin=''; document.head.appendChild(s); }
    add('https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js');
    setTimeout(function(){
      if(!window.QRCode){
        add('https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js');
      }
    }, 1200);
  })();
  </script>

  <!-- ===== APP REACT ===== -->
  <script type="text/babel" data-presets="env,react">
    // =========================================================
    // =============== UTILITAIRES & CONFIG GLOBALE ============
    // =========================================================
    const { useState, useEffect, useMemo, useRef } = React;

    // URL Google Apps Script (fixée & "cachée" dans le code)
    const COLLECT_URL = "https://script.google.com/macros/s/AKfycbzdyXL0JuBmuu-0v6qVW9ow5vZf3UwuoAR5tqn2rYLXpDTJCStGbLcccP4R5wEb0EQ7lA/exec";

    // Date/heure locale -> format HTML datetime-local
    const nowLocalDateTime = () => {
      const d = new Date(); const pad = (n)=>n.toString().padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    // Clés de stockage (localStorage)
    const STORAGE_KEY_LMRA     = "lmra_mobile_current_v3_2";
    const STORAGE_KEY_FIRSTAID = "firstaid_current_v1";
    const STORAGE_KEY_STOP     = "stop_current_v1";
    const OUTBOX_KEY           = "lmra_outbox_v1";

    // Router ultra-simple via hash (#/home, #/lmra, #/first-aid, #/stop)
    const parseRoute = () => (location.hash.replace(/^#\/?/, '') || 'home');

    // Petits helpers UI
    function Section({ title, children }){ return <section className="bg-white rounded-2xl shadow p-4 mb-4"><h2 className="text-lg font-semibold mb-2">{title}</h2>{children}</section>; }
    function Row({ children }){ return <div className="flex flex-col gap-3">{children}</div>; }
    function Toggle({ checked, onChange, label }){ return <label className="flex items-center justify-between gap-3 py-2"><span className="text-sm">{label}</span><input type="checkbox" className="w-5 h-5 accent-black" checked={checked} onChange={(e)=>onChange(e.target.checked)} /></label>; }
    function Divider(){ return <hr className="my-3 border-gray-200" />; }

    // Hook localStorage <-> state
    function useLocalStorage(key, initial){
      const [val,setVal] = useState(()=>{ try{ const raw=localStorage.getItem(key); return raw? JSON.parse(raw): initial; }catch{return initial;} });
      useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} },[key,val]);
      return [val,setVal];
    }

    // Logo QHSE (SVG) cliquable
    function QHSELogo({size=28}) {
      return (
        <svg width={size} height={size} viewBox="0 0 64 64" aria-hidden="true">
          <rect x="0" y="0" width="64" height="64" rx="12" fill="#111827"></rect>
          <text x="50%" y="40%" dominantBaseline="middle" textAnchor="middle" fill="white" fontWeight="700" fontFamily="system-ui, -apple-system, Segoe UI, Roboto" fontSize="22">QH</text>
          <text x="50%" y="75%" dominantBaseline="middle" textAnchor="middle" fill="white" fontWeight="700" fontFamily="system-ui, -apple-system, Segoe UI, Roboto" fontSize="22">SE</text>
        </svg>
      );
    }

    // =========================================================
    // ========================= APP (HUB) =====================
    // =========================================================
    function App(){
      const [route, setRoute] = useState(parseRoute());
      useEffect(()=>{
        const onHash = ()=>setRoute(parseRoute());
        window.addEventListener('hashchange', onHash);
        return ()=>window.removeEventListener('hashchange', onHash);
      },[]);

      return (
        <div>
          {/* ===== HEADER commun avec logo QHSE (retour accueil) ===== */}
          <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
            <div className="max-w-md mx-auto px-4 py-3 flex items-center justify-between gap-2">
              <div className="flex items-center gap-3">
                <a href="#/" aria-label="Accueil"><QHSELogo size={28} /></a>
                <h1 className="text-base font-semibold">
                  {route==="home" ? "VMA – Apps chantier" :
                   route==="lmra" ? "LMRA – Mobile (v3.2)" :
                   route==="first-aid" ? "Premiers soins" :
                   route==="stop" ? "STOP – Imprévu" : ""}
                </h1>
              </div>
              <button onClick={()=>window.print()} className="px-3 py-1.5 rounded-xl border">Imprimer</button>
            </div>
          </header>

          {/* ===== ROUTES ===== */}
          {route==="home" && <HomeScreen />}
          {route==="lmra" && <LmraScreen />}
          {route==="first-aid" && <FirstAidScreen />}
          {route==="stop" && <StopScreen />}

          {/* ===== FOOTER ===== */}
          <footer className="max-w-md mx-auto px-4 pb-8 text-center text-xs text-gray-400">
            {route==="home" ? "VMA – Hub PWA"
              : route==="lmra" ? "LMRA – v3.2 PWA"
              : route==="first-aid" ? "Premiers soins – PWA"
              : "STOP – PWA"}
          </footer>
        </div>
      );
    }

    // =========================================================
    // ====================== HOME (HUB) =======================
    // =========================================================
    function HomeScreen(){
      // URL à encoder dans le QR (sans hash)
      const installUrl = (location.origin + location.pathname).replace(/#.*$/,'');
      const canvasRef = useRef(null);

      // États QR : prêt/erreur
      const [qrReady, setQrReady] = useState(!!window.QRCode);
      const [qrError, setQrError] = useState(false);

      // Attente chargement lib QR (polling 200ms jusqu'à 2s)
      useEffect(() => {
        if (qrReady) return;
        let tries = 0;
        const timer = setInterval(() => {
          if (window.QRCode) {
            setQrReady(true);
            clearInterval(timer);
          } else if (++tries > 10) {
            clearInterval(timer);
            setQrError(true);
          }
        }, 200);
        return () => clearInterval(timer);
      }, [qrReady]);

      // Dessiner le QR dans le canvas quand la lib est prête
      useEffect(() => {
        if (!qrReady || !canvasRef.current) return;
        try {
          window.QRCode.toCanvas(
            canvasRef.current,
            installUrl,
            { width: 200, errorCorrectionLevel: 'M' },
            (err) => { if (err) setQrError(true); }
          );
        } catch {
          setQrError(true);
        }
      }, [qrReady, installUrl]);

      return (
        <main className="max-w-md mx-auto p-4">
          {/* ===== Tuiles des apps ===== */}
          <Section title="Applications chantier">
            <div className="grid grid-cols-2 gap-3">
              {/* Tuile LMRA */}
              <a href="#/lmra" className="group bg-white border rounded-2xl p-4 shadow hover:shadow-md transition flex flex-col items-center justify-center gap-3">
                <svg viewBox="0 0 48 48" className="w-14 h-14">
                  <rect x="6" y="6" width="36" height="36" rx="8" fill="#111827"></rect>
                  <path d="M16 18h16M16 24h16M16 30h10" stroke="white" strokeWidth="3" strokeLinecap="round"/>
                  <path d="M14 24l2 2 4-4" stroke="#34d399" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
                <div className="text-center">
                  <div className="font-semibold">LMRA</div>
                  <div className="text-xs text-gray-500">Analyse de risque</div>
                </div>
              </a>

              {/* Tuile Premiers soins */}
              <a href="#/first-aid" className="group bg-white border rounded-2xl p-4 shadow hover:shadow-md transition flex flex-col items-center justify-center gap-3">
                <svg viewBox="0 0 48 48" className="w-14 h-14">
                  <rect x="4" y="4" width="40" height="40" rx="10" fill="#16a34a"></rect>
                  <rect x="21" y="12" width="6" height="24" fill="white"></rect>
                  <rect x="12" y="21" width="24" height="6" fill="white"></rect>
                </svg>
                <div className="text-center">
                  <div className="font-semibold">Premiers soins</div>
                  <div className="text-xs text-gray-500">Utilisation trousse</div>
                </div>
              </a>

              {/* Tuile STOP */}
              <a href="#/stop" className="group bg-white border rounded-2xl p-4 shadow hover:shadow-md transition flex flex-col items-center justify-center gap-3">
                <svg viewBox="0 0 48 48" className="w-14 h-14">
                  <rect x="17" y="6" width="14" height="36" rx="7" fill="#111827"></rect>
                  <circle cx="24" cy="14" r="4.5" fill="#ef4444"></circle>
                  <circle cx="24" cy="24" r="4.5" fill="#f59e0b"></circle>
                  <circle cx="24" cy="34" r="4.5" fill="#22c55e"></circle>
                </svg>
                <div className="text-center">
                  <div className="font-semibold">STOP chantier</div>
                  <div className="text-xs text-gray-500">Imprévu / arrêt</div>
                </div>
              </a>
            </div>
          </Section>

          {/* ===== QR d'installation (local via canvas + fallback image) ===== */}
          <Section title="Installer sur mobile">
            <div className="flex flex-col items-center gap-2">
              {(!qrError && qrReady) ? (
                /* QR généré en local (canvas) */
                <canvas ref={canvasRef} width={200} height={200} className="w-40 h-40 rounded-lg border bg-white" />
              ) : (
                /* Fallback image si la lib n’a pas pu se charger */
                <img
                  src={"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(installUrl)}
                  alt="QR code d'installation"
                  className="w-40 h-40 rounded-lg border bg-white"
                />
              )}
              <div className="text-xs text-gray-500">Scannez avec l’appareil photo pour ouvrir l’app.</div>
            </div>
          </Section>
        </main>
      );
    }

    // =========================================================
    // ==================== COMPOSANTS LMRA ====================
    // =========================================================
    function Team({data,setData}){
      const add = ()=>{ const name = data.teamInput.trim(); if(!name) return; if(data.team.includes(name)) return setData({...data, teamInput:""}); setData({...data, team:[...data.team, name], teamInput:""}); };
      return (
        <div>
          <div className="flex gap-2 mb-2">
            <input value={data.teamInput} onChange={(e)=>setData({...data, teamInput:e.target.value})} placeholder="Nom & prénom" className="flex-1 px-3 py-2 rounded-xl border" />
            <button onClick={add} className="px-3 py-2 rounded-xl border">Ajouter</button>
          </div>
          <div className="flex flex-wrap gap-2">
            {data.team.map((t)=> (
              <span key={t} className="inline-flex items-center gap-2 text-sm px-3 py-1 rounded-full bg-gray-100">
                {t}
                <button onClick={()=>setData({...data, team: data.team.filter(n=>n!==t)})} className="w-5 h-5 inline-flex items-center justify-center rounded-full border border-gray-300">×</button>
              </span>
            ))}
            {!data.team.length && <span className="text-sm text-gray-400">(Ajouter les membres)</span>}
          </div>
        </div>
      );
    }
    function Permits({data,setData}){
      return (
        <div>
          <div className="text-sm font-medium mb-2">Permis requis</div>
          <div className="grid grid-cols-2 gap-2">
            <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.feu} onChange={(e)=>setData({...data, permits:{...data.permits, feu:e.target.checked}})} />Feu</label>
            <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.electrique} onChange={(e)=>setData({...data, permits:{...data.permits, electrique:e.target.checked}})} />Électrique</label>
            <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.confine} onChange={(e)=>setData({...data, permits:{...data.permits, confine:e.target.checked}})} />Espace confiné</label>
            <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.levage} onChange={(e)=>setData({...data, permits:{...data.permits, levage:e.target.checked}})} />Levage</label>
            <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.autre} onChange={(e)=>setData({...data, permits:{...data.permits, autre:e.target.checked}})} />Autre</label>
            <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.permits.na} onChange={(e)=>setData({...data, permits:{...data.permits, na:e.target.checked}})} />N/A</label>
          </div>
          {data.permits.autre && <input value={data.permits.autreText} onChange={(e)=>setData({...data, permits:{...data.permits, autreText:e.target.value}})} placeholder="Préciser l’autre permis" className="mt-2 w-full px-3 py-2 rounded-xl border" />}
        </div>
      );
    }
    function Energies({data,setData}){
      return (
        <div>
          <div className="text-sm font-medium mb-2">Énergies</div>
          <div className="grid grid-cols-2 gap-2">
            {["electrique","mecanique","fluide","gravite"].map(k => (
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.energies[k]} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, [k]:e.target.checked}}})} />
                {k==="electrique"?"Électrique":k==="mecanique"?"Mécanique":k==="fluide"?"Hydraulique/Pneumatique":"Gravité"}
              </label>
            ))}
            <label className="flex items-center gap-2 text-sm col-span-2"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.energies.autre} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, autre:e.target.checked}}})} />Autre</label>
          </div>
          {data.risks.energies.autre && <input value={data.risks.energies.autreText} onChange={(e)=>setData({...data, risks:{...data.risks, energies:{...data.risks.energies, autreText:e.target.value}}})} placeholder="Préciser l’autre énergie" className="mt-2 w-full px-3 py-2 rounded-xl border" />}
        </div>
      );
    }
    function Environnement({data,setData}){
      return (
        <div>
          <div className="text-sm font-medium mb-2">Environnement</div>
          <div className="grid grid-cols-2 gap-2">
            {["hauteur","meteo","bruit","poussiere","thermique","chimique"].map(k => (
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.environnement[k]} onChange={(e)=>setData({...data, risks:{...data.risks, environnement:{...data.risks.environnement, [k]:e.target.checked}}})} />
                {k==="hauteur"?"Hauteur":k==="meteo"?"Vent/Météo":k==="bruit"?"Bruit":k==="poussiere"?"Poussières":k==="thermique"?"Chaleur/Froid":"Produits chimiques"}
              </label>
            ))}
          </div>
        </div>
      );
    }
    function Operations({data,setData}){
      return (
        <div>
          <div className="text-sm font-medium mb-2">Opérations</div>
          <div className="grid grid-cols-2 gap-2">
            {["trafic","levage","outillage","atex","confine"].map(k => (
              <label key={k} className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.operations[k]} onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, [k]:e.target.checked}}})} />
                {k==="trafic"?"Circulation / engins":k==="levage"?"Levage":k==="outillage"?"Outillage portatif":k==="atex"?"ATEX":"Espace confiné"}
              </label>
            ))}
            <label className="flex items-center gap-2 text-sm col-span-2"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.risks.operations.autres} onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, autres:e.target.checked}}})} />Autres</label>
          </div>
          {data.risks.operations.autres && <input value={data.risks.operations.autresText} onChange={(e)=>setData({...data, risks:{...data.risks, operations:{...data.risks.operations, autresText:e.target.value}}})} placeholder="Préciser autres opérations" className="mt-2 w-full px-3 py-2 rounded-xl border" />}
        </div>
      );
    }
    function Measures({data,setData}){
      return (
        <div className="grid grid-cols-2 gap-2">
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.septRegles} onChange={(e)=>setData({...data, measures:{...data.measures, septRegles:e.target.checked}})} />7 règles consignation + test</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.ventilation} onChange={(e)=>setData({...data, measures:{...data.measures, ventilation:e.target.checked}})} />Ventilation / mesure gaz</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.terre} onChange={(e)=>setData({...data, measures:{...data.measures, terre:e.target.checked}})} />Mise à la terre</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.balisage} onChange={(e)=>setData({...data, measures:{...data.measures, balisage:e.target.checked}})} />Balisage / zonage</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.surveillant} onChange={(e)=>setData({...data, measures:{...data.measures, surveillant:e.target.checked}})} />Observateur / surveillant</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.planLevage} onChange={(e)=>setData({...data, measures:{...data.measures, planLevage:e.target.checked}})} />Plan de levage / CMU vérifiée</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.ancrage} onChange={(e)=>setData({...data, measures:{...data.measures, ancrage:e.target.checked}})} />Ancrage / chutes d’objets</label>
          <label className="flex items-center gap-2 text-sm"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.outilsOk} onChange={(e)=>setData({...data, measures:{...data.measures, outilsOk:e.target.checked}})} />Outils conformes / inspection</label>
          <label className="flex items-center gap-2 text-sm col-span-2"><input type="checkbox" className="w-4 h-4 accent-black" checked={data.measures.autre} onChange={(e)=>setData({...data, measures:{...data.measures, autre:e.target.checked}})} />Autre</label>
          {data.measures.autre && <input value={data.measures.autreText} onChange={(e)=>setData({...data, measures:{...data.measures, autreText:e.target.value}})} placeholder="Préciser autre mesure" className="mt-2 w-full px-3 py-2 rounded-xl border col-span-2" />}
        </div>
      );
    }

    // =========================================================
    // ====================== ÉCRAN LMRA =======================
    // =========================================================
    function LmraScreen(){
      // État initial LMRA
      const initialLmra = ()=>({
        version: "v3.2",
        datetime: nowLocalDateTime(),
        site: "", task: "", responsable: "", team: [], teamInput: "",
        conditions: { tacheClaires: false, coactivite: false, zonage: false, epi: false },
        permits: { feu: false, electrique: false, confine: false, levage: false, autre: false, autreText: "", na: false },
        risks: { energies: { electrique: false, mecanique: false, fluide: false, gravite: false, autre: false, autreText: "" },
                 environnement: { hauteur: false, meteo: false, bruit: false, poussiere: false, thermique: false, chimique: false },
                 operations: { trafic: false, levage: false, outillage: false, atex: false, confine: false, autres: false, autresText: "" } },
        measures: { septRegles: false, ventilation: false, terre: false, balisage: false, surveillant: false, planLevage: false, ancrage: false, outilsOk: false, autre: false, autreText: "" },
        top3: [ { risk:"", action:"", resp:"" }, { risk:"", action:"", resp:"" }, { risk:"", action:"", resp:"" } ],
        decision: "GO", noGo: { name:"", tel:"" }, notes: "",
      });

      // State + persistance
      const [data, setData] = useState(()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY_LMRA); return raw? JSON.parse(raw) : initialLmra(); }catch{ return initialLmra(); }});
      const [outbox, setOutbox] = useLocalStorage(OUTBOX_KEY, []);
      const [busy, setBusy] = useState(false);
      useEffect(()=>{ try{ localStorage.setItem(STORAGE_KEY_LMRA, JSON.stringify(data)); }catch{} },[data]);

      const setField = (k,v)=>setData({...data,[k]:v});

      // Validation d’envoi (champs requis + NO-GO)
      const canSend = useMemo(()=>{
        const baseOk = !!(data.site.trim() && data.task.trim() && data.responsable.trim());
        if (data.decision !== "NO-GO") return baseOk;
        return baseOk && data.noGo.name.trim() && data.noGo.tel.trim();
      }, [data]);
      const missing = useMemo(()=>{
        const m = [];
        if(!data.site.trim()) m.push("Site");
        if(!data.task.trim()) m.push("Tâche");
        if(!data.responsable.trim()) m.push("Responsable");
        if(data.decision==="NO-GO"){
          if(!data.noGo.name.trim()) m.push("Nom (NO-GO)");
          if(!data.noGo.tel.trim())  m.push("Téléphone (NO-GO)");
        }
        return m;
      }, [data]);

      // Après envoi, on garde Responsable + Équipe + refresh datetime
      function resetAfterSend(prev){
        const n = initialLmra();
        n.responsable = prev.responsable;
        n.team = [...prev.team];
        n.datetime = nowLocalDateTime();
        return n;
      }

      // Payload + envoi
      function payload(){ return { meta: { formType:"lmra", sentAt:new Date().toISOString(), page:location.href, userAgent:navigator.userAgent }, data }; }
      async function sendNow(p){ try{ setBusy(true); await fetch(COLLECT_URL,{ method:"POST", mode:"no-cors", headers:{ "Content-Type":"text/plain" }, body:JSON.stringify(p)}); return true; } catch { return false; } finally { setBusy(false);} }
      async function envoyer(){
        if(!canSend){ alert("Complétez : "+missing.join(", ")); return; }
        const p=payload(); const ok=await sendNow(p);
        if(ok){ alert("Envoyé ✅"); setData(resetAfterSend(data)); }
        else { setOutbox([p,...outbox].slice(0,500)); alert("Pas de réseau : enregistré localement."); }
      }

      return (
        <main className="max-w-md mx-auto p-4">
          {/* Réinitialisation complète en tête */}
          <Section title="Réinitialiser rapidement">
            <Row>
              <button onClick={()=>setData(initialLmra())} className="px-4 py-2 rounded-xl border">Réinitialiser le formulaire (tout remettre à zéro)</button>
              <p className="text-xs text-gray-500">À utiliser si l’<b>équipe change</b> (Responsable &amp; Équipe seront vidés).</p>
            </Row>
          </Section>

          {/* Infos générales */}
          <Section title="Infos générales">
            <Row>
              <label className="text-sm">Date & heure
                <input type="datetime-local" value={data.datetime} onChange={(e)=>setField("datetime", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Site / Zone
                <input required value={data.site} onChange={(e)=>setField("site", e.target.value)} placeholder="Ex: Bât. A – Toiture" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Tâche
                <input required value={data.task} onChange={(e)=>setField("task", e.target.value)} placeholder="Ex: Remplacement moteur ventilo" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Responsable (Nom & Prénom)
                <input required value={data.responsable} onChange={(e)=>setField("responsable", e.target.value)} placeholder="Ex: Jean Dupont" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <div><label className="text-sm block mb-2">Équipe</label><Team data={data} setData={setData} /></div>
            </Row>
          </Section>

          {/* Conditions / Permis */}
          <Section title="Conditions du jour">
            <Row>
              <Toggle checked={data.conditions.tacheClaires} onChange={(v)=>setData({...data, conditions:{...data.conditions, tacheClaires:v}})} label="Tâche & étapes claires" />
              <Toggle checked={data.conditions.coactivite} onChange={(v)=>setData({...data, conditions:{...data.conditions, coactivite:v}})} label="Co-activité / interfaces gérées" />
              <Toggle checked={data.conditions.zonage} onChange={(v)=>setData({...data, conditions:{...data.conditions, zonage:v}})} label="Zone balisée / accès maîtrisé" />
              <Toggle checked={data.conditions.epi} onChange={(v)=>setData({...data, conditions:{...data.conditions, epi:v}})} label="EPI adaptés portés" />
              <Divider /><Permits data={data} setData={setData} />
            </Row>
          </Section>

          {/* Risques / Mesures */}
          <Section title="Risques présents"><Row><Energies data={data} setData={setData} /><Divider /><Environnement data={data} setData={setData} /><Divider /><Operations data={data} setData={setData} /></Row></Section>
          <Section title="Mesures de maîtrise"><Row><Measures data={data} setData={setData} /></Row></Section>

          {/* Top 3 */}
          <Section title="Top 3 risques & actions">
            <Row>
              {data.top3.map((t,i)=>(
                <div key={i} className="grid grid-cols-1 gap-2">
                  <div className="text-sm font-medium">#{i+1}</div>
                  <input value={t.risk} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], risk:e.target.value}; setField("top3", top3); }} placeholder="Risque" className="px-3 py-2 rounded-xl border" />
                  <input value={t.action} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], action:e.target.value}; setField("top3", top3); }} placeholder="Action immédiate" className="px-3 py-2 rounded-xl border" />
                  <input value={t.resp} onChange={(e)=>{ const top3=[...data.top3]; top3[i]={...top3[i], resp:e.target.value}; setField("top3", top3); }} placeholder="Responsable" className="px-3 py-2 rounded-xl border" />
                  <Divider/>
                </div>
              ))}
            </Row>
          </Section>

          {/* Décision */}
          <Section title="Décision">
            <Row>
              <div className="flex items-center gap-3">
                <button onClick={()=>setField("decision","GO")} className={"px-4 py-2 rounded-xl border "+(data.decision==="GO"?"bg-green-50 border-green-300":"")}>GO</button>
                <button onClick={()=>setField("decision","NO-GO")} className={"px-4 py-2 rounded-xl border "+(data.decision==="NO-GO"?"bg-red-50 border-red-300":"")}>NO-GO</button>
              </div>
              {data.decision==="NO-GO" && (
                <div className="grid grid-cols-1 gap-2">
                  <input value={data.noGo.name} onChange={(e)=>setField("noGo",{...data.noGo, name:e.target.value})} placeholder="Nom à prévenir" className={"px-3 py-2 rounded-xl border "+(!data.noGo.name.trim()?"border-red-500":"")} />
                  <input value={data.noGo.tel} onChange={(e)=>setField("noGo",{...data.noGo, tel:e.target.value})} placeholder="Téléphone" className={"px-3 py-2 rounded-xl border "+(!data.noGo.tel.trim()?"border-red-500":"")} />
                  {(!data.noGo.name.trim() || !data.noGo.tel.trim()) && <p className="text-xs text-red-600">Nom & téléphone requis en NO-GO.</p>}
                </div>
              )}
              <label className="text-sm">Notes
                <textarea value={data.notes} onChange={(e)=>setField("notes", e.target.value)} rows={2} placeholder="Observations…" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
            </Row>
          </Section>

          {/* Envoi */}
          <Section title="Sauvegarder / Envoyer">
            <Row>
              <button onClick={envoyer} disabled={!canSend || busy} aria-disabled={!canSend || busy}
                title={!canSend ? ("Complétez : "+missing.join(", ")) : ""}
                className={"px-4 py-3 rounded-xl border text-white "+(canSend && !busy ? "bg-black" : "bg-gray-400 cursor-not-allowed opacity-60")}>
                {busy ? "Envoi en cours…" : "Envoyer"}
              </button>
            </Row>
          </Section>
        </main>
      );
    }

    // =========================================================
    // ================== ÉCRAN PREMIERS SOINS =================
    // =========================================================
    function FirstAidScreen(){
      // État initial
      const initialFA = ()=>({
        version: "fa-v1",
        datetime: nowLocalDateTime(),
        chantier: "",
        responsable: "",
        personne: "",
        actions: { coupant:false, disquant:false, soudant:false, percant:false, tirant:false, soulevant:false, autre:false, autreText:"" },
        blessures: { coupure:false, egratignure:false, contusion:false, projection:false, brulure:false, autre:false, autreText:"" },
        localisation: { main:false, bras:false, torse:false, jambe:false, pied:false, tete:false, oeil:false, autre:false, autreText:"" },
        recharge:false, trousseNumero:"",
        remarques:""
      });

      const [fa, setFA] = useState(()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY_FIRSTAID); return raw? JSON.parse(raw) : initialFA(); }catch{ return initialFA(); }});
      const [outbox, setOutbox] = useLocalStorage(OUTBOX_KEY, []);
      const [busy, setBusy] = useState(false);
      useEffect(()=>{ try{ localStorage.setItem(STORAGE_KEY_FIRSTAID, JSON.stringify(fa)); }catch{} },[fa]);

      const setField = (k,v)=>setFA({...fa,[k]:v});
      const setAction = (k,v)=>setFA({...fa, actions:{...fa.actions,[k]:v}});
      const setBless  = (k,v)=>setFA({...fa, blessures:{...fa.blessures,[k]:v}});
      const setLoc    = (k,v)=>setFA({...fa, localisation:{...fa.localisation,[k]:v}});

      // Validation : chantier + responsable + personne ; si recharge=oui => n° trousse requis
      const canSend = useMemo(()=>{
        const base = !!(fa.chantier.trim() && fa.responsable.trim() && fa.personne.trim());
        if(!base) return false;
        if(fa.recharge) return !!fa.trousseNumero.trim();
        return true;
      }, [fa]);
      const missing = useMemo(()=>{
        const m=[];
        if(!fa.chantier.trim()) m.push("Chantier");
        if(!fa.personne.trim()) m.push("Personne concernée");
        if(!fa.responsable.trim()) m.push("Responsable");
        if(fa.recharge && !fa.trousseNumero.trim()) m.push("N° trousse");
        return m;
      },[fa]);

      // Après envoi : garder Responsable + datetime
      function resetAfterSend(prev){ const n = initialFA(); n.responsable = prev.responsable; n.datetime = nowLocalDateTime(); return n; }
      function payload(){ return { meta: { formType:"firstAid", sentAt:new Date().toISOString(), page: location.href, userAgent:navigator.userAgent }, data: fa }; }
      async function sendNow(p){ try{ setBusy(true); await fetch(COLLECT_URL,{ method:"POST", mode:"no-cors", headers:{ "Content-Type":"text/plain" }, body:JSON.stringify(p)}); return true; } catch { return false; } finally { setBusy(false);} }
      async function envoyer(){ if(!canSend){ alert("Complétez : "+missing.join(", ")); return; } const p=payload(); const ok=await sendNow(p);
        if(ok){ alert("Envoyé ✅"); setFA(resetAfterSend(fa)); } else { setOutbox([p,...outbox].slice(0,500)); alert("Pas de réseau : enregistré localement."); } }

      return (
        <main className="max-w-md mx-auto p-4">
          <Section title="Réinitialiser rapidement"><Row><button onClick={()=>setFA(initialFA())} className="px-4 py-2 rounded-xl border">Réinitialiser le formulaire (tout remettre à zéro)</button></Row></Section>

          <Section title="Informations">
            <Row>
              <label className="text-sm">Date & heure
                <input type="datetime-local" value={fa.datetime} onChange={(e)=>setField("datetime", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Chantier
                <input value={fa.chantier} onChange={(e)=>setField("chantier", e.target.value)} placeholder="Ex: Bât. A – Toiture" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Responsable
                <input value={fa.responsable} onChange={(e)=>setField("responsable", e.target.value)} placeholder="Ex: Jean Dupont" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Personne concernée
                <input value={fa.personne} onChange={(e)=>setField("personne", e.target.value)} placeholder="Ex: Ouvrier / Collaborateur" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
            </Row>
          </Section>

          <Section title="Action (au moment du fait)">
            <div className="grid grid-cols-2 gap-2">
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.actions.coupant}   onChange={e=>setAction("coupant",e.target.checked)}  className="w-4 h-4 accent-black"/>En coupant</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.actions.disquant}  onChange={e=>setAction("disquant",e.target.checked)} className="w-4 h-4 accent-black"/>En disquant</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.actions.soudant}   onChange={e=>setAction("soudant",e.target.checked)}  className="w-4 h-4 accent-black"/>En soudant</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.actions.percant}   onChange={e=>setAction("percant",e.target.checked)}  className="w-4 h-4 accent-black"/>En perçant</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.actions.tirant}    onChange={e=>setAction("tirant",e.target.checked)}   className="w-4 h-4 accent-black"/>En tirant/poussant</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.actions.soulevant} onChange={e=>setAction("soulevant",e.target.checked)}className="w-4 h-4 accent-black"/>En soulevant/déposant</label>
              <label className="flex items-center gap-2 text-sm col-span-2"><input type="checkbox" checked={fa.actions.autre} onChange={e=>setAction("autre",e.target.checked)} className="w-4 h-4 accent-black"/>Autre</label>
            </div>
            {fa.actions.autre && (
              <input value={fa.actions.autreText} onChange={(e)=>setFA({...fa, actions:{...fa.actions, autreText:e.target.value}})}
                    placeholder="Préciser l’action" className="mt-2 w-full px-3 py-2 rounded-xl border" />
            )}
          </Section>

          <Section title="Blessure">
            <div className="grid grid-cols-1 gap-2">
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.blessures.coupure}      onChange={e=>setBless("coupure",e.target.checked)} className="w-4 h-4 accent-black"/>Coupure</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.blessures.egratignure}   onChange={e=>setBless("egratignure",e.target.checked)} className="w-4 h-4 accent-black"/>Égratignure</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.blessures.contusion}     onChange={e=>setBless("contusion",e.target.checked)} className="w-4 h-4 accent-black"/>Contusion <span className="text-gray-500">(bleu/bosse)</span></label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.blessures.projection}    onChange={e=>setBless("projection",e.target.checked)} className="w-4 h-4 accent-black"/>Projection <span className="text-gray-500">(poussière/matière)</span></label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.blessures.brulure}       onChange={e=>setBless("brulure",e.target.checked)} className="w-4 h-4 accent-black"/>Brûlure</label>
              <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={fa.blessures.autre}         onChange={e=>setBless("autre",e.target.checked)} className="w-4 h-4 accent-black"/>Autre</label>
            </div>
            {fa.blessures.autre && (
              <input value={fa.blessures.autreText} onChange={(e)=>setFA({...fa, blessures:{...fa.blessures, autreText:e.target.value}})}
                    placeholder="Préciser la blessure" className="mt-2 w-full px-3 py-2 rounded-xl border" />
            )}
          </Section>

          <Section title="Localisation de la lésion">
            <div className="grid grid-cols-2 gap-2">
              {[
                ["main","Main"],["bras","Bras"],["torse","Torse"],["jambe","Jambe"],
                ["pied","Pied"],["tete","Tête"],["oeil","Œil"]
              ].map(([k,label])=>(
                <label key={k} className="flex items-center gap-2 text-sm">
                  <input type="checkbox" checked={fa.localisation[k]} onChange={e=>setLoc(k,e.target.checked)} className="w-4 h-4 accent-black" />{label}
                </label>
              ))}
              <label className="flex items-center gap-2 text-sm col-span-2">
                <input type="checkbox" checked={fa.localisation.autre} onChange={e=>setLoc("autre",e.target.checked)} className="w-4 h-4 accent-black" />Autre
              </label>
            </div>
            {fa.localisation.autre && (
              <input value={fa.localisation.autreText} onChange={(e)=>setFA({...fa, localisation:{...fa.localisation, autreText:e.target.value}})}
                    placeholder="Préciser la localisation" className="mt-2 w-full px-3 py-2 rounded-xl border" />
            )}
          </Section>

          <Section title="Trousse de secours">
            <Row>
              <div className="flex items-center gap-3">
                <span className="text-sm">Faut-il recharger la trousse ?</span>
                <label className="text-sm flex items-center gap-1"><input type="radio" name="recharge" checked={!fa.recharge} onChange={()=>setField("recharge",false)} />Non</label>
                <label className="text-sm flex items-center gap-1"><input type="radio" name="recharge" checked={fa.recharge}  onChange={()=>setField("recharge",true)}  />Oui</label>
              </div>
              {fa.recharge && (
                <input value={fa.trousseNumero} onChange={(e)=>setField("trousseNumero", e.target.value)}
                      placeholder="Numéro de la trousse" className={"px-3 py-2 rounded-xl border "+(!fa.trousseNumero.trim()?"border-red-500":"")} />
              )}
            </Row>
          </Section>

          <Section title="Remarques"><Row><textarea value={fa.remarques} onChange={(e)=>setField("remarques", e.target.value)} rows={3} placeholder="Observations / produits utilisés…" className="w-full px-3 py-2 rounded-xl border" /></Row></Section>

          <Section title="Envoyer">
            <Row>
              <button onClick={envoyer} disabled={!canSend || busy} aria-disabled={!canSend || busy}
                title={!canSend ? ("Complétez : "+missing.join(", ")) : ""}
                className={"px-4 py-3 rounded-xl border text-white "+(canSend && !busy ? "bg-black" : "bg-gray-400 cursor-not-allowed opacity-60")}>
                {busy ? "Envoi en cours…" : "Envoyer"}
              </button>
              {!canSend && <p className="text-xs text-red-600">Champs requis : <b>{missing.join(", ")}</b></p>}
            </Row>
          </Section>
        </main>
      );
    }

    // =========================================================
    // ====================== ÉCRAN STOP =======================
    // =========================================================
    function StopScreen(){
      const initialSTOP = ()=>({
        version: "stop-v1",
        datetime: nowLocalDateTime(),
        chantier: "",
        responsable: "",
        situation: "",
        callNom: "",
        callFonction: "",
        solution: "",
        noGo: ""
      });

      const [st, setST] = useState(()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY_STOP); return raw? JSON.parse(raw) : initialSTOP(); }catch{ return initialSTOP(); }});
      const [outbox, setOutbox] = useLocalStorage(OUTBOX_KEY, []);
      const [busy, setBusy] = useState(false);
      useEffect(()=>{ try{ localStorage.setItem(STORAGE_KEY_STOP, JSON.stringify(st)); }catch{} },[st]);

      const setField = (k,v)=>setST({...st,[k]:v});
      const canSend = useMemo(()=>!!(st.chantier.trim() && st.responsable.trim() && st.situation.trim()), [st]);
      const missing = useMemo(()=>{
        const m=[]; if(!st.chantier.trim()) m.push("Chantier"); if(!st.responsable.trim()) m.push("Responsable"); if(!st.situation.trim()) m.push("Situation (STOP)"); return m;
      }, [st]);

      function resetAfterSend(prev){ const n = initialSTOP(); n.responsable = prev.responsable; n.datetime = nowLocalDateTime(); return n; }
      function payload(){ return { meta: { formType:"stop", sentAt:new Date().toISOString(), page: location.href, userAgent:navigator.userAgent }, data: st }; }
      async function sendNow(p){ try{ setBusy(true); await fetch(COLLECT_URL,{ method:"POST", mode:"no-cors", headers:{ "Content-Type":"text/plain" }, body:JSON.stringify(p)}); return true; } catch { return false; } finally { setBusy(false);} }
      async function envoyer(){ if(!canSend){ alert("Complétez : "+missing.join(", ")); return; } const p=payload(); const ok=await sendNow(p);
        if(ok){ alert("Envoyé ✅"); setST(resetAfterSend(st)); } else { setOutbox([p,...outbox].slice(0,500)); alert("Pas de réseau : enregistré localement."); } }

      // Petite box colorée pour STOP/CALL/ACT
      const Box = ({color, children}) => {
        const colors = color==="red"   ? "border-red-500 bg-red-50" :
                       color==="orange"? "border-orange-500 bg-orange-50" :
                       color==="green" ? "border-green-600 bg-green-50" : "border-gray-300 bg-gray-50";
        return <div className={"rounded-xl border-2 p-3 "+colors}>{children}</div>;
      };

      return (
        <main className="max-w-md mx-auto p-4">
          <Section title="Réinitialiser rapidement">
            <Row><button onClick={()=>setST(initialSTOP())} className="px-4 py-2 rounded-xl border">Réinitialiser le formulaire (tout remettre à zéro)</button></Row>
          </Section>

          <Section title="Coordonnées">
            <Row>
              <label className="text-sm">Date & heure
                <input type="datetime-local" value={st.datetime} onChange={(e)=>setField("datetime", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Chantier
                <input value={st.chantier} onChange={(e)=>setField("chantier", e.target.value)} placeholder="Ex: Bât. A – Zone X" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
              <label className="text-sm">Responsable
                <input value={st.responsable} onChange={(e)=>setField("responsable", e.target.value)} placeholder="Ex: Jean Dupont" className="mt-1 w-full px-3 py-2 rounded-xl border" />
              </label>
            </Row>
          </Section>

          <Section title="STOP">
            <Box color="red">
              <label className="text-sm">Expliquer la situation qui a amené au STOP
                <textarea value={st.situation} onChange={(e)=>setField("situation", e.target.value)} rows={3} placeholder="Décrivez clairement le danger ou l’écart constaté…" className="mt-1 w-full px-3 py-2 rounded-xl border bg-white" />
              </label>
            </Box>
          </Section>

          <Section title="CALL">
            <Box color="orange">
              <div className="grid grid-cols-1 gap-2">
                <label className="text-sm">Responsable contacté – Nom
                  <input value={st.callNom} onChange={(e)=>setField("callNom", e.target.value)} placeholder="Nom de la personne" className="mt-1 w-full px-3 py-2 rounded-xl border bg-white" />
                </label>
                <label className="text-sm">Fonction
                  <select value={st.callFonction} onChange={(e)=>setField("callFonction", e.target.value)} className="mt-1 w-full px-3 py-2 rounded-xl border bg-white">
                    <option value="">Sélectionner…</option>
                    <option value="chef">Chef d'équipe</option>
                    <option value="site">Site sup.</option>
                    <option value="pm">PM</option>
                    <option value="opm">OPM</option>
                    <option value="cp">CP</option>
                    <option value="coord">Coordinateur</option>
                    <option value="client">Client</option>
                  </select>
                </label>
              </div>
            </Box>
          </Section>

          <Section title="ACT">
            <Box color="green">
              <div className="grid grid-cols-1 gap-2">
                <label className="text-sm">Solution mise en place
                  <textarea value={st.solution} onChange={(e)=>setField("solution", e.target.value)} rows={3} placeholder="Décrivez la mesure corrective appliquée…" className="mt-1 w-full px-3 py-2 rounded-xl border bg-white" />
                </label>
                <label className="text-sm">NO-GO — Situation en attente de solution
                  <textarea value={st.noGo} onChange={(e)=>setField("noGo", e.target.value)} rows={2} placeholder="Si aucune solution immédiate, décrire la situation en attente…" className="mt-1 w-full px-3 py-2 rounded-xl border bg-white" />
                </label>
              </div>
            </Box>
          </Section>

          <Section title="Envoyer">
            <Row>
              <button onClick={envoyer} disabled={!canSend || busy} aria-disabled={!canSend || busy}
                title={!canSend ? ("Complétez : "+missing.join(", ")) : ""}
                className={"px-4 py-3 rounded-xl border text-white "+(canSend && !busy ? "bg-black" : "bg-gray-400 cursor-not-allowed opacity-60")}>
                {busy ? "Envoi en cours…" : "Envoyer"}
              </button>
              {!canSend && <p className="text-xs text-red-600">Champs requis : <b>{missing.join(", ")}</b></p>}
            </Row>
          </Section>
        </main>
      );
    }

    // ===== MONTER L’APP =====
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
